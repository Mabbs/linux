{
  "version": 3,
  "sources": ["../src/util.ts", "../src/wasm.ts"],
  "sourcesContent": ["export function assert(\n  cond: unknown,\n  message = \"Assertation failed\",\n): asserts cond {\n  if (!cond) throw new Error(message);\n}\n\nexport function unreachable(_: never, message = \"Unreachable reached\"): never {\n  throw new Error(message);\n}\n\nexport function get_script_path(fn: () => void, import_meta: ImportMeta) {\n  const match = fn.toString().match(/import\\(\"(.*)\"\\)/)?.[1];\n  assert(match, \"Could not find imported path\");\n  return new URL(match, import_meta.url);\n}\n\nexport class EventEmitter<Events> {\n  #subscribers: { [K in keyof Events]?: Set<(data: Events[K]) => void> } = {};\n  on<K extends keyof Events>(event: K, handler: (data: Events[K]) => void) {\n    (this.#subscribers[event] ??= new Set()).add(handler);\n  }\n  off<K extends keyof Events>(event: K, handler: (data: Events[K]) => void) {\n    this.#subscribers[event]?.delete(handler);\n  }\n  protected emit<K extends keyof Events>(event: K, data: Events[K]) {\n    this.#subscribers[event]?.forEach((handler) => handler(data));\n  }\n}\n", "export interface Instance extends WebAssembly.Instance {\n  exports: {\n    __indirect_function_table: WebAssembly.Table;\n    boot(): void;\n    trigger_irq_for_cpu(cpu: number, irq: number): void;\n    syscall(\n      nr: number,\n      arg0: number,\n      arg1: number,\n      arg2: number,\n      arg3: number,\n      arg4: number,\n      arg5: number,\n    ): number;\n    get_thread_area(): number;\n    get_args_length(): number;\n    get_args(buf: number): number;\n  };\n}\n\nexport interface Imports {\n  env: { memory: WebAssembly.Memory };\n  boot: {\n    get_devicetree(buf: number, size: number): void;\n    get_initramfs(buf: number, size: number): number;\n  };\n  kernel: {\n    breakpoint(): void;\n    halt_worker(): void;\n    boot_console_write(msg: number, len: number): void;\n    boot_console_close(): void;\n    return_address(_level: number): number;\n    get_now_nsec(): bigint;\n    get_stacktrace(buf: number, size: number): void;\n    spawn_worker(\n      fn: number,\n      arg: number,\n      comm: number,\n      comm_len: number,\n      share_user_memory: number,\n    ): void;\n    run_on_main(fn: number, arg: number): void;\n  };\n  user: {\n    compile(buf: number, size: number): number;\n    instantiate(fresh_memory: number): void;\n    call(): void;\n    switch_entry(fn: number, arg: number): void;\n    call_signal_handler(fn: number, sig: number): void;\n    read(to: number, from: number, n: number): number;\n    write(to: number, from: number, n: number): number;\n    write_zeroes(to: number, n: number): number;\n  };\n  virtio: {\n    set_features(dev: number, features: bigint): void;\n\n    setup(\n      dev: number,\n      irq: number,\n      is_config_addr: number,\n      is_vring_addr: number,\n      config_addr: number,\n      config_len: number,\n    ): void;\n\n    enable_vring(\n      dev: number,\n      vq: number,\n      size: number,\n      desc_addr: number,\n    ): void;\n    disable_vring(dev: number, vq: number): void;\n\n    notify(dev: number, vq: number): void;\n  };\n}\n\nexport function kernel_imports(\n  {\n    is_worker,\n    memory,\n    spawn_worker,\n    boot_console_write,\n    boot_console_close,\n    run_on_main,\n    get_user_module,\n    get_user_memory,\n  }: {\n    is_worker: boolean;\n    memory: WebAssembly.Memory;\n    spawn_worker: (\n      fn: number,\n      arg: number,\n      name: string,\n      user_module: WebAssembly.Module | null,\n      user_memory: WebAssembly.Memory | null,\n    ) => void;\n    boot_console_write: (message: ArrayBuffer) => void;\n    boot_console_close: () => void;\n    run_on_main: (fn: number, arg: number) => void;\n    get_user_module: () => WebAssembly.Module | null;\n    get_user_memory: () => WebAssembly.Memory | null;\n  },\n): Imports[\"kernel\"] {\n  const mem = new Uint8Array(memory.buffer);\n  return {\n    breakpoint: () => {\n      // deno-lint-ignore no-debugger\n      debugger;\n    },\n    halt_worker: () => {\n      if (!is_worker) throw new Error(\"Halt called in main thread\");\n      self.close();\n    },\n\n    boot_console_write: (msg, len) => {\n      boot_console_write(memory.buffer.slice(msg, msg + len));\n    },\n    boot_console_close,\n\n    return_address: (_level) => {\n      return 0;\n    },\n\n    get_now_nsec: () => {\n      /*\n        The more straightforward way to do this is\n        `BigInt(Math.round(performance.now() * 1_000_000))`.\n        Below is semantically identical but has less floating point\n        inaccuracy.\n        `performance.now()` has 5\u03BCs precision in the browser.\n        In server runtimes it has full nanosecond precision, but this code\n        rounds to the same 5\u03BCs precision.\n      */\n      return BigInt(\n        Math.round((performance.now() + performance.timeOrigin) * 200),\n      ) * 5000n;\n    },\n\n    get_stacktrace: (buf, size) => {\n      // 5 lines: strip Error, strip 4 common lines of stack\n      const trace = new TextEncoder().encode(\n        new Error().stack?.split(\"\\n\").slice(5).join(\"\\n\"),\n      );\n      if (trace.byteLength > size) {\n        /// 46 = \".\"\n        trace[size - 1] = 46;\n        trace[size - 2] = 46;\n        trace[size - 3] = 46;\n      }\n      mem.set(trace.slice(0, size), buf);\n    },\n\n    spawn_worker: (fn, arg, comm, comm_len, share_user_memory) => {\n      const name = new TextDecoder().decode(\n        mem.slice(comm, comm + comm_len),\n      );\n      spawn_worker(\n        fn,\n        arg,\n        name,\n        share_user_memory ? get_user_module() : null,\n        share_user_memory ? get_user_memory() : null,\n      );\n    },\n\n    run_on_main,\n  };\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;AAAO,SAAS,OACd,MACA,UAAU,sBACI;AACd,MAAI,CAAC,KAAM,OAAM,IAAI,MAAM,OAAO;AACpC;AAEO,SAAS,YAAY,GAAU,UAAU,uBAA8B;AAC5E,QAAM,IAAI,MAAM,OAAO;AACzB;AAEO,SAAS,gBAAgB,IAAgB,aAAyB;AACvE,QAAM,QAAQ,GAAG,SAAS,EAAE,MAAM,kBAAkB,IAAI,CAAC;AACzD,SAAO,OAAO,8BAA8B;AAC5C,SAAO,IAAI,IAAI,OAAO,YAAY,GAAG;AACvC;AAEO,IAAM,eAAN,MAA2B;AAAA,EAChC,eAAyE,CAAC;AAAA,EAC1E,GAA2B,OAAU,SAAoC;AACvE,KAAC,KAAK,aAAa,KAAK,MAAM,oBAAI,IAAI,GAAG,IAAI,OAAO;AAAA,EACtD;AAAA,EACA,IAA4B,OAAU,SAAoC;AACxE,SAAK,aAAa,KAAK,GAAG,OAAO,OAAO;AAAA,EAC1C;AAAA,EACU,KAA6B,OAAU,MAAiB;AAChE,SAAK,aAAa,KAAK,GAAG,QAAQ,CAAC,YAAY,QAAQ,IAAI,CAAC;AAAA,EAC9D;AACF;;;ACiDO,SAAS,eACd;AAAA,EACE;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AACF,GAgBmB;AACnB,QAAM,MAAM,IAAI,WAAW,OAAO,MAAM;AACxC,SAAO;AAAA,IACL,YAAY,MAAM;AAEhB;AAAA,IACF;AAAA,IACA,aAAa,MAAM;AACjB,UAAI,CAAC,UAAW,OAAM,IAAI,MAAM,4BAA4B;AAC5D,WAAK,MAAM;AAAA,IACb;AAAA,IAEA,oBAAoB,CAAC,KAAK,QAAQ;AAChC,yBAAmB,OAAO,OAAO,MAAM,KAAK,MAAM,GAAG,CAAC;AAAA,IACxD;AAAA,IACA;AAAA,IAEA,gBAAgB,CAAC,WAAW;AAC1B,aAAO;AAAA,IACT;AAAA,IAEA,cAAc,MAAM;AAUlB,aAAO;AAAA,QACL,KAAK,OAAO,YAAY,IAAI,IAAI,YAAY,cAAc,GAAG;AAAA,MAC/D,IAAI;AAAA,IACN;AAAA,IAEA,gBAAgB,CAAC,KAAK,SAAS;AAE7B,YAAM,QAAQ,IAAI,YAAY,EAAE;AAAA,QAC9B,IAAI,MAAM,EAAE,OAAO,MAAM,IAAI,EAAE,MAAM,CAAC,EAAE,KAAK,IAAI;AAAA,MACnD;AACA,UAAI,MAAM,aAAa,MAAM;AAE3B,cAAM,OAAO,CAAC,IAAI;AAClB,cAAM,OAAO,CAAC,IAAI;AAClB,cAAM,OAAO,CAAC,IAAI;AAAA,MACpB;AACA,UAAI,IAAI,MAAM,MAAM,GAAG,IAAI,GAAG,GAAG;AAAA,IACnC;AAAA,IAEA,cAAc,CAAC,IAAI,KAAK,MAAM,UAAU,sBAAsB;AAC5D,YAAM,OAAO,IAAI,YAAY,EAAE;AAAA,QAC7B,IAAI,MAAM,MAAM,OAAO,QAAQ;AAAA,MACjC;AACA;AAAA,QACE;AAAA,QACA;AAAA,QACA;AAAA,QACA,oBAAoB,gBAAgB,IAAI;AAAA,QACxC,oBAAoB,gBAAgB,IAAI;AAAA,MAC1C;AAAA,IACF;AAAA,IAEA;AAAA,EACF;AACF;",
  "names": []
}
